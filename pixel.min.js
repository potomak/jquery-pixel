var PIXEL=function(){function x(a,b){this.canvas=a;this.ctx=a.getContext("2d");this.settings=b;this.clearCanvas=function(){this.canvas.width=this.canvas.width};this.drawGrid=function(){if(this.settings.showGrid){for(var a=0.5+this.settings.pixelSize;a<this.settings.size;a+=this.settings.pixelSize)this.ctx.moveTo(a,0),this.ctx.lineTo(a,this.settings.size),this.ctx.moveTo(0,a),this.ctx.lineTo(this.settings.size,a);this.ctx.strokeStyle=this.settings.gridColor;this.ctx.stroke()}};this.getDataURL=function(){return this.canvas.toDataURL("image/png")};
this.draw=function(a){this.clearCanvas();for(var b=0;b<a.length;b++)for(var d=0;d<a[b].length;d++)this.ctx.fillStyle=a[b][d],this.ctx.fillRect(b*this.settings.pixelSize,d*this.settings.pixelSize,this.settings.pixelSize,this.settings.pixelSize);this.drawGrid()}}var y=!1,b=[],n=[],t=null,f=0,r=null,s=[],z=!1,u="pixel",G={pixelSize:1,size:16,gridColor:"#eeeeee",showGrid:!1},p={pixelSize:20,size:320,gridColor:"#eeeeee",showGrid:!1},g={action:[],undo:[],oldUndo:[],redo:[]},v=function(){var a=p.size/p.pixelSize;
b=[];for(var d=0;d<a;d++)b.push(Array(a));for(d=0;d<b.length;d++)for(a=0;a<b[d].length;a++)b[d][a]="rgba(0, 0, 0, 0)"},w=function(){g={action:[],undo:[],oldUndo:[],redo:[]};h()},m=function(a){y&&console.log([(new Date).toString(),a])},A=function(a){s[a].clearCanvas();f==a&&(r.clearCanvas(),n[f]=null,v(),w())},l=function(a){if("undefined"!=typeof a){for(var b=a.slice(),c=0;c<a.length;c++)b[c]=a[c].slice();return b}},B=function(a,d){var c=Math.floor(a/d);c>=b.length&&(c=b.length-1);0>=c&&(c=0);return c},
o=function(a,d,c){var e=b[a][d];return e!=c?(b[a][d]=c,h(),e):!1},C=function(a,d){return"rgba(0, 0, 0, 0)"==b[a][d]?"#ffffff":b[a][d]},D=function(a,d,c){var e=C(a,d);if(e!=c){var g=l(b),k=(new Date).getTime();q(a,d,e,c);m("flood fill time: "+((new Date).getTime()-k));h();return g}return!1},q=function(a,d,c,e){0<=a&&a<b[0].length&&0<=d&&d<b.length&&C(a,d)==c&&(b[a][d]=e,q(a+1,d,c,e),q(a-1,d,c,e),q(a,d+1,c,e),q(a,d-1,c,e))},h=function(a){"undefined"==typeof a?a=b:b=l(a);r.clearCanvas();s[f].clearCanvas();
r.draw(a);s[f].draw(a)},E=function(a){return f==a?b:n[a]},F=function(a){m("setCurrentFrame: "+a);a!=f&&(n[f]=l(b),b=l(n[a]),"undefined"==typeof b&&(n[a]=null,v()),f=a,w(),m("setCurrentFrame - frames.length: "+n.length))};return{init:function(a,b,c){r=new x(a,p);for(a=0;a<b.length;a++)s[a]=new x(b[a],G);"undefined"!=typeof c&&(y=c);v();w()},clearCanvasAt:A,clearCanvas:function(){A(f)},removeFrame:function(a){n.splice(a,1)},setDraw:function(a){z=a},setAction:function(a){u=a},doAction:function(a,b,c){if(z){var e=
B(a,p.pixelSize),f=B(b,p.pixelSize);switch(u){case "pixel":var k=o(e,f,c);!1!=k&&(g.undo.push(function(){o(e,f,k)}),g.action.push(function(){o(e,f,c)}));break;case "clearPixel":k=o(e,f,"rgba(0, 0, 0, 0)");!1!=k&&(g.undo.push(function(){o(e,f,k)}),g.action.push(function(){o(e,f,"rgba(0, 0, 0, 0)")}));break;case "fill":var l=D(e,f,c);!1!=k&&(g.undo.push(function(){h(l)}),g.action.push(function(){D(e,f,c)}));break;default:m("unknown action:"+u)}}},getHistory:function(){return g},undo:function(){if(0<
g.undo.length){var a=g.undo.pop();a.call();g.redo.push(g.action.pop());g.oldUndo.push(a)}},getFrame:E,setCurrentFrame:F,getCurrentFrame:function(){return b},getCurrentFrameId:function(){return f},play:function(a,b){1<n.length&&(t=setInterval(function(){activeFrame=(f+1)%n.length;m(["play animation","activeFrame: "+activeFrame,"currentFrame: "+f,"frames.length: "+n.length]);F(activeFrame);b(activeFrame)},1E3*(1/a)))},stop:function(){clearInterval(t);t=null},moveRight:function(){var a=l(b),d=(new Date).getTime();
for(j=0;j<b[0].length;j++){var c=b[b.length-1][j];for(i=b.length-1;0<i;i--)b[i][j]=b[i-1][j];b[0][j]=c}m("move right time: "+((new Date).getTime()-d));h();g.undo.push(function(){h(a)})},moveTop:function(){for(var a=l(b),d=(new Date).getTime(),c=0;c<b.length;c++)b[c].push(b[c].shift());m("move top time: "+((new Date).getTime()-d));h();g.undo.push(function(){h(a)})},flipHorizontal:function(){for(var a=l(b),d=(new Date).getTime(),c=0;c<b.length/2;c++)for(var e=0;e<b[c].length;e++){var f=b[c][e],k=b.length;
b[c][e]=b[k-1-c][e];b[k-1-c][e]=f}m("flip vertical time: "+((new Date).getTime()-d));h();g.undo.push(function(){h(a)})},flipVertical:function(){for(var a=l(b),d=(new Date).getTime(),c=0;c<b.length;c++)for(var e=0;e<b[c].length/2;e++){var f=b[c][e],k=b[c].length;b[c][e]=b[c][k-1-e];b[c][k-1-e]=f}m("flip vertical time: "+((new Date).getTime()-d));h();g.undo.push(function(){h(a)})},rotate:function(){for(var a=l(b),d=(new Date).getTime(),c=0;c<b.length;c++)for(var e=0;e<b[c].length;e++)b[c][e]=a[b[c].length-
1-e][c];m("rotate time: "+((new Date).getTime()-d));h();g.undo.push(function(){h(a)})},copyFrameAt:function(a){var d=l(b),c=(new Date).getTime();b=l(E(a));m("copyFrameAt "+a+": "+((new Date).getTime()-c));h();g.undo.push(function(){h(d)})},log:m}}();

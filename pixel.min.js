var PIXEL=function(){function y(a,b){this.canvas=a;this.ctx=a.getContext("2d");this.settings=b;this.clearCanvas=function(){this.canvas.width=this.canvas.width};this.drawGrid=function(){if(this.settings.showGrid){for(var a=0.5+this.settings.pixelSize;a<this.settings.size;a+=this.settings.pixelSize)this.ctx.moveTo(a,0),this.ctx.lineTo(a,this.settings.size),this.ctx.moveTo(0,a),this.ctx.lineTo(this.settings.size,a);this.ctx.strokeStyle=this.settings.gridColor;this.ctx.stroke()}};this.getDataURL=function(){return this.canvas.toDataURL("image/png")};
this.draw=function(a){this.clearCanvas();for(var b=0;b<a.length;b++)for(var d=0;d<a[b].length;d++)this.ctx.fillStyle=a[b][d],this.ctx.fillRect(b*this.settings.pixelSize,d*this.settings.pixelSize,this.settings.pixelSize,this.settings.pixelSize);this.drawGrid()}}var z=!1,b=[],n=[],u=null,g=0,s=null,t=[],A=!1,v="pixel",F={pixelSize:1,size:16,gridColor:"#eeeeee",showGrid:!1},q={pixelSize:20,size:320,gridColor:"#eeeeee",showGrid:!1},f={action:[],undo:[],oldUndo:[],redo:[]},w=function(){var a=q.size/q.pixelSize;
b=[];for(var d=0;d<a;d++)b.push(Array(a));for(d=0;d<b.length;d++)for(a=0;a<b[d].length;a++)b[d][a]="rgba(0, 0, 0, 0)"},x=function(){f={action:[],undo:[],oldUndo:[],redo:[]};h()},l=function(a){z&&console.log([(new Date).toString(),a])},m=function(a){if("undefined"!=typeof a){for(var b=a.slice(),c=0;c<a.length;c++)b[c]=a[c].slice();return b}},B=function(a,d){var c=Math.floor(a/d);c>=b.length&&(c=b.length-1);0>=c&&(c=0);return c},p=function(a,d,c){var e=b[a][d];return e!=c?(b[a][d]=c,h(),e):!1},C=function(a,
d){return"rgba(0, 0, 0, 0)"==b[a][d]?"#ffffff":b[a][d]},D=function(a,d,c){var e=C(a,d);if(e!=c){var f=m(b),k=(new Date).getTime();r(a,d,e,c);l("flood fill time: "+((new Date).getTime()-k));h();return f}return!1},r=function(a,d,c,e){0<=a&&a<b[0].length&&0<=d&&d<b.length&&C(a,d)==c&&(b[a][d]=e,r(a+1,d,c,e),r(a-1,d,c,e),r(a,d+1,c,e),r(a,d-1,c,e))},h=function(a){"undefined"==typeof a?a=b:b=m(a);s.clearCanvas();t[g].clearCanvas();s.draw(a);t[g].draw(a)},E=function(a){l("setCurrentFrame: "+a);a!=g&&(n[g]=
m(b),b=m(n[a]),"undefined"==typeof b&&(n[a]=null,w()),g=a,x(),l("setCurrentFrame - frames.length: "+n.length))};return{init:function(a,b,c){s=new y(a,q);for(a=0;a<b.length;a++)t[a]=new y(b[a],F);"undefined"!=typeof c&&(z=c);w();x()},clearCanvas:function(){s.clearCanvas();t[g].clearCanvas();n[g]=null;w();x()},setDraw:function(a){A=a},setAction:function(a){v=a},doAction:function(a,b,c){if(A){var e=B(a,q.pixelSize),o=B(b,q.pixelSize);switch(v){case "pixel":var k=p(e,o,c);!1!=k&&(f.undo.push(function(){p(e,
o,k)}),f.action.push(function(){p(e,o,c)}));break;case "clearPixel":k=p(e,o,"rgba(0, 0, 0, 0)");!1!=k&&(f.undo.push(function(){p(e,o,k)}),f.action.push(function(){p(e,o,"rgba(0, 0, 0, 0)")}));break;case "fill":var g=D(e,o,c);!1!=k&&(f.undo.push(function(){h(g)}),f.action.push(function(){D(e,o,c)}));break;default:l("unknown action:"+v)}}},getHistory:function(){return f},undo:function(){if(0<f.undo.length){var a=f.undo.pop();a.call();f.redo.push(f.action.pop());f.oldUndo.push(a)}},redo:function(){if(0<
f.redo.length){var a=f.redo.pop();a.call();f.undo.push(f.oldUndo.pop());f.action.push(a)}},getFrame:function(a){return g==a?b:n[a]},setCurrentFrame:E,getCurrentFrame:function(){return b},getCurrentFrameId:function(){return g},play:function(a,b){1<n.length&&(u=setInterval(function(){activeFrame=(g+1)%n.length;l(["play animation","activeFrame: "+activeFrame,"currentFrame: "+g,"frames.length: "+n.length]);E(activeFrame);b(activeFrame)},1E3*(1/a)))},stop:function(){clearInterval(u);u=null},moveRight:function(){var a=
m(b),d=(new Date).getTime();for(j=0;j<b[0].length;j++){var c=b[b.length-1][j];for(i=b.length-1;0<i;i--)b[i][j]=b[i-1][j];b[0][j]=c}l("move right time: "+((new Date).getTime()-d));h();f.undo.push(function(){h(a)})},moveTop:function(){for(var a=m(b),d=(new Date).getTime(),c=0;c<b.length;c++)b[c].push(b[c].shift());l("move top time: "+((new Date).getTime()-d));h();f.undo.push(function(){h(a)})},flipHorizontal:function(){for(var a=m(b),d=(new Date).getTime(),c=0;c<b.length/2;c++)for(var e=0;e<b[c].length;e++){var g=
b[c][e],k=b.length;b[c][e]=b[k-1-c][e];b[k-1-c][e]=g}l("flip vertical time: "+((new Date).getTime()-d));h();f.undo.push(function(){h(a)})},flipVertical:function(){for(var a=m(b),d=(new Date).getTime(),c=0;c<b.length;c++)for(var e=0;e<b[c].length/2;e++){var g=b[c][e],k=b[c].length;b[c][e]=b[c][k-1-e];b[c][k-1-e]=g}l("flip vertical time: "+((new Date).getTime()-d));h();f.undo.push(function(){h(a)})},rotate:function(){for(var a=m(b),d=(new Date).getTime(),c=0;c<b.length;c++)for(var e=0;e<b[c].length;e++)b[c][e]=
a[b[c].length-1-e][c];l("rotate time: "+((new Date).getTime()-d));h();f.undo.push(function(){h(a)})},copyFrameAt:function(a){var d=m(b),c=(new Date).getTime();b=m(n[a]);l("copyFrameAt "+a+": "+((new Date).getTime()-c));h();f.undo.push(function(){h(d)})},log:l}}();

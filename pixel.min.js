var PIXEL=function(){var y=!1,e=[],h=[],u=null,k=0,n=null,p=null,s=null,z=!1,v="pixel",g={action:[],undo:[],oldUndo:[],redo:[]},w=function(){e=[];for(var a=0;16>a;a++)e.push(Array(16));for(a=0;a<e.length;a++)for(var b=0;b<e[a].length;b++)e[a][b]="rgba(0, 0, 0, 0)"},x=function(){g={action:[],undo:[],oldUndo:[],redo:[]};l()},m=function(a){y&&console.log([(new Date).toString(),a])},o=function(a){if("undefined"!=typeof a){for(var b=a.slice(),d=0;d<a.length;d++)b[d]=a[d].slice();return b}},q=function(a){a=
Math.floor(a/20);a>=e.length&&(a=e.length-1);0>=a&&(a=0);return a},r=function(a,b,d){var a=q(a),b=q(b),f=e[a][b];return f!=d?(e[a][b]=d,l(),f):!1},A=function(a,b){var d=e[q(a)][q(b)];return"rgba(0, 0, 0, 0)"==d?"#ffffff":d},B=function(a,b,d){var f=A(a,b);if(f!=d){var g=o(e),h=(new Date).getTime();t(a,b,f,d);m("flood fill time: "+((new Date).getTime()-h));l();return g}return!1},t=function(a,b,d,f){A(a,b)==d&&0<a&&0<b&&320>a&&320>b&&(e[q(a)][q(b)]=f,t(a+20,b,d,f),t(a-20,b,d,f),t(a,b+20,d,f),t(a,b-20,
d,f))},l=function(a){p.width=p.width;"undefined"==typeof a&&(a=e);if(null!=n&&"undefined"!=typeof h[n]&&null!=h[n])for(var b=0;b<h[n].length;b++)for(var d=0;d<h[n][b].length;d++)c=h[n][b][d],"rgba(0, 0, 0, 0)"!=c&&(components=c.match(/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/),c="rgba("+new Number("0x"+components[1])+", "+new Number("0x"+components[2])+", "+new Number("0x"+components[3])+", 0.5)"),s.fillStyle=c,s.fillRect(20*b,20*d,20,20);for(b=0;b<a.length;b++)for(d=0;d<a[b].length;d++)s.fillStyle=
e[b][d]=a[b][d],s.fillRect(20*b,20*d,20,20)},C=function(a){m("setCurrentFrame: "+a);a!=k&&(h[k]=o(e),e=o(h[a]),"undefined"==typeof e&&(h[a]=null,w()),k=a,x(),m("setCurrentFrame - frames.length: "+h.length))};return{init:function(a,b){p=a;s=a.getContext("2d");"undefined"!=typeof b&&(y=b);w();x()},clearCanvas:function(){p.width=p.width;h[k]=null;w();x()},setDraw:function(a){z=a},setAction:function(a){v=a},doAction:function(a,b,d){if(z)switch(v){case "pixel":var e=r(a,b,d);!1!=e&&(g.undo.push(function(){r(a,
b,e)}),g.action.push(function(){r(a,b,d)}));break;case "clearPixel":e=r(a,b,"rgba(0, 0, 0, 0)");!1!=e&&(g.undo.push(function(){r(a,b,e)}),g.action.push(function(){r(a,b,"rgba(0, 0, 0, 0)")}));break;case "fill":var h=B(a,b,d);!1!=e&&(g.undo.push(function(){l(h)}),g.action.push(function(){B(a,b,d)}));break;default:m("unknown action:"+v)}},getDataURL:function(){return p.toDataURL("image/png")},getHistory:function(){return g},undo:function(){if(0<g.undo.length){var a=g.undo.pop();a.call();g.redo.push(g.action.pop());
g.oldUndo.push(a)}},redo:function(){if(0<g.redo.length){var a=g.redo.pop();a.call();g.undo.push(g.oldUndo.pop());g.action.push(a)}},getFrame:function(a){return k==a?e:h[a]},setCurrentFrame:C,setOnionFrame:function(a){n=a;l()},getCurrentOnionFrameId:function(){return n},getCurrentFrame:function(){return e},getCurrentFrameId:function(){return k},play:function(a,b){1<h.length&&(u=setInterval(function(){activeFrame=(k+1)%h.length;m(["play animation","activeFrame: "+activeFrame,"currentFrame: "+k,"frames.length: "+
h.length]);C(activeFrame);b(activeFrame)},1E3*(1/a)))},stop:function(){clearInterval(u);u=null},moveRight:function(){var a=o(e),b=(new Date).getTime();for(j=0;j<e[0].length;j++){var d=e[e.length-1][j];for(i=e.length-1;0<i;i--)e[i][j]=e[i-1][j];e[0][j]=d}m("move right time: "+((new Date).getTime()-b));l();g.undo.push(function(){l(a)})},moveTop:function(){for(var a=o(e),b=(new Date).getTime(),d=0;d<e.length;d++)e[d].push(e[d].shift());m("move top time: "+((new Date).getTime()-b));l();g.undo.push(function(){l(a)})},
flipHorizontal:function(){for(var a=o(e),b=(new Date).getTime(),d=0;d<e.length/2;d++)for(var f=0;f<e[d].length;f++){var h=e[d][f],k=e.length;e[d][f]=e[k-1-d][f];e[k-1-d][f]=h}m("flip vertical time: "+((new Date).getTime()-b));l();g.undo.push(function(){l(a)})},flipVertical:function(){for(var a=o(e),b=(new Date).getTime(),d=0;d<e.length;d++)for(var f=0;f<e[d].length/2;f++){var h=e[d][f],k=e[d].length;e[d][f]=e[d][k-1-f];e[d][k-1-f]=h}m("flip vertical time: "+((new Date).getTime()-b));l();g.undo.push(function(){l(a)})},
log:m}}();
